<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Shiny Events</title>
  <meta name="description" content="Концертите на Shiny — график, новини и пуш известия.">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icon-192.png">
  <meta name="theme-color" content="#111111">
  <style>
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#0f0f10;color:#eee}
    header{padding:24px 16px;border-bottom:1px solid #222;position:sticky;top:0;background:#0f0f10}
    .container{max-width:960px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    .card{padding:16px;border:1px solid #222;border-radius:16px}
    button{padding:12px 16px;border-radius:12px;border:1px solid #333;background:#1a1a1b;color:#eee;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    a{color:inherit}
    iframe{width:100%;min-height:600px;border:0;border-radius:12px}
    footer{padding:24px 16px;color:#999;border-top:1px solid #222}
    .tip{font-size:.9rem;color:#bbb}
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1 style="margin:0">Shiny Events</h1>
      <div class="tip">PWA сайт — инсталирай от менюто на браузъра (Add to Home Screen).</div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <h2 style="margin-top:0">Абонирай се за известия</h2>
        <p>Натисни бутона, за да получаваш web push при нов концерт.</p>
        <button id="subscribeBtn">Абонирай ме</button>
        <p class="tip">На iPhone: добави сайта на Home Screen и отвори от иконата, за да разрешиш известия.</p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">Календар с концерти</h2>
        <iframe
          src="https://calendar.google.com/calendar/embed?src=9bac831570f5d3e35b1261209d5771dc6619c4ce71f09c9e2724d19973541915%40group.calendar.google.com&ctz=Europe%2FSofia"
          loading="lazy"></iframe>
        <p class="tip">
          <a href="https://calendar.google.com/calendar/ical/9bac831570f5d3e35b1261209d5771dc6619c4ce71f09c9e2724d19973541915%40group.calendar.google.com/public/basic.ics" download>
            Свали .ics
          </a>
        </p>
      </section>

      <section class="card">
        <h2 style="margin-top:0">Събития (примерни)</h2>
        <div id="events"></div>
      </section>
    </div>
  </main>

  <footer class="container">
    <div>© <span id="year"></span> Shiny Events</div>
  </footer>

  <!-- OneSignal SDK v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    // PWA service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js');
      });
    }

    // Зареждане на примерни събития
    fetch('./events.json').then(r => r.json()).then(list => {
      const wrap = document.getElementById('events');
      wrap.innerHTML = list.map(ev => {
        return `<div style="margin:8px 0;padding:12px;border:1px solid #333;border-radius:12px">
          <strong>${ev.title}</strong><br>
          ${new Date(ev.date).toLocaleString('bg-BG')} — ${ev.venue}
        </div>`;
      }).join('');
    });

    document.getElementById('year').textContent = new Date().getFullYear();

    // OneSignal init (нов API)
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "347845c9-a96f-49a5-8505-724accf392b3",
        notifyButton: { enable: false } // изключваме вградения бутон, ползваме нашия
      });

      const btn = document.getElementById('subscribeBtn');

      async function updateBtn() {
        const state = await OneSignal.User.PushSubscription.optedIn();
        btn.textContent = state ? "Абониран си ✔" : "Абонирай ме";
        btn.disabled = state;
      }

      btn.addEventListener('click', async () => {
        try {
          await OneSignal.Notifications.requestPermission();
        } catch (e) {
          console.warn("Permission error:", e);
        }
        updateBtn();
      });

      updateBtn();
    });
  </script>
</body>
</html>
